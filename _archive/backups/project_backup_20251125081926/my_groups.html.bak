<!-- my_groups.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StokvelPRO — My Groups</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#1a365d; /* brand */
      --accent-variant:#2b6cb0;
      --radius:12px;
      --shadow: 0 6px 18px rgba(17,24,39,0.08);
      --glass: rgba(26,54,93,0.06);
    }
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#0f172a;}
    .wrap{max-width:1100px;margin:36px auto;padding:28px;}
    header{display:flex;align-items:center;gap:18px;margin-bottom:28px}
    header img.logo{width:84px;height:84px;object-fit:contain;border-radius:14px;background:var(--glass);padding:12px}
    header h1{font-size:24px;margin:0;color:var(--accent)}
    .top-actions{margin-left:auto;display:flex;gap:12px}
    .btn{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(26,54,93,0.12)}
    .btn-ghost{background:transparent;border:1px solid #e6eef9;color:var(--accent)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:22px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;min-height:140px;display:flex;flex-direction:column;justify-content:space-between}
    .card h3{margin:0 0 8px 0;color:#0b1220;font-size:18px}
    .card small{color:var(--muted)}
    .card .meta{display:flex;gap:12px;align-items:center;margin-top:12px}
    .pill{background:rgba(26,54,93,0.06);padding:6px 10px;border-radius:999px;color:var(--accent);font-weight:600}
    .card-actions{display:flex;gap:10px;margin-top:12px}
    .empty{padding:28px;border-radius:var(--radius);text-align:center;background:linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);box-shadow:var(--shadow)}
    .help{color:var(--muted);font-size:14px;margin-top:12px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start}.top-actions{margin-left:0;width:100%;justify-content:space-between}}
  </style>
</head>
<body>
<div id="header"></div>

  <div class="wrap">
    <header>
      <!-- LOCAL LOGO (option 3). I used the project file path you have in workspace -->
      <img class="logo" src="/mnt/data/CompressJPEG.Online_img(512x512)%20(1).jpg" alt="StokvelPRO logo">
      <div>
        <h1>Stokvel PRO</h1>
        <div style="color:var(--muted);font-size:13px">My groups — manage memberships and open group dashboards</div>
      </div>

      <div class="top-actions">
        <button class="btn btn-ghost" onclick="window.location='create_stokvel.html'">Create Stokvel</button>
        <button class="btn btn-primary" onclick="window.location='join_stokvel.html'">Join Stokvel</button>
      </div>
    </header>

    <section id="content">
      <div id="loading" class="empty">Loading your groups…</div>
      <div id="groupsGrid" class="grid" style="display:none"></div>
      <div id="noGroups" style="display:none" class="empty">
        <strong>No groups yet</strong>
        <p class="help">You are not a member of any stokvels yet. Create one or join using a code.</p>
        <div style="margin-top:12px">
          <button class="btn btn-primary" onclick="window.location='create_stokvel.html'">Create a Group</button>
          <button class="btn btn-ghost" onclick="window.location='join_stokvel.html'">Join with Code</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase + Firestore code (ES Modules) -->
  <script type="module">
    // ---------- FIREBASE IMPORTS ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, updateDoc, serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ---------- FIREBASE CONFIG (your config) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAUIOcaIXcVRPBCG_95-TttwYD32yoJSG8",
      authDomain: "stokvelpro.firebaseapp.com",
      projectId: "stokvelpro",
      storageBucket: "stokvelpro.firebasestorage.app",
      messagingSenderId: "655524343942",
      appId: "1:655524343942:web:03d5ca1374a794e3ee6107"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const loadingEl = document.getElementById('loading');
    const groupsGrid = document.getElementById('groupsGrid');
    const noGroups = document.getElementById('noGroups');

    // check auth, then load groups
    onAuthStateChanged(auth, async user => {
      if (!user) {
        // Not logged in — go back to login
        window.location.href = 'index.html';
        return;
      }
      // store user globally
      window.currentUser = user;
      try {
        await loadUserGroups(user.uid);
      } catch (err) {
        console.error('Failed to load groups', err);
        loadingEl.textContent = 'Error loading groups — check console.';
      }
    });

    // Load groups and filter client-side by membership
    async function loadUserGroups(uid) {
      loadingEl.style.display = '';
      groupsGrid.style.display = 'none';
      noGroups.style.display = 'none';
      groupsGrid.innerHTML = '';

      const colRef = collection(db, 'groups');
      const snap = await getDocs(colRef);

      // Collect groups where members array contains an object with uid == current uid
      const userGroups = [];
      snap.forEach(docSnap => {
        const g = { id: docSnap.id, ...docSnap.data() };
        // If group stores members as array of objects: [{uid,role,...}]
        if (Array.isArray(g.members)) {
          const found = g.members.some(m => {
            if (typeof m === 'string') return m === uid; // fallback if member stored as string uid
            return m && (m.uid === uid || m.userId === uid);
          });
          if (found) userGroups.push(g);
        } else {
          // fallback: if createdBy equals user
          if (g.createdBy === uid) userGroups.push(g);
        }
      });

      loadingEl.style.display = 'none';
      if (!userGroups.length) {
        noGroups.style.display = '';
        return;
      }
      // render cards
      groupsGrid.style.display = 'grid';
      userGroups.forEach(g => groupsGrid.appendChild(renderGroupCard(g)));
    }

    // Build card DOM element for a group
    function renderGroupCard(group) {
      const card = document.createElement('div');
      card.className = 'card';

      const title = document.createElement('div');
      const h3 = document.createElement('h3');
      h3.textContent = group.groupName || 'Untitled Group';
      title.appendChild(h3);

      const subtitle = document.createElement('div');
      subtitle.innerHTML = `<small>Code: <strong>${group.groupCode || '—'}</strong> &nbsp; · &nbsp; Created by: ${shortenId(group.createdBy)}</small>`;

      // member count
      const membersCount = Array.isArray(group.members) ? group.members.length : 0;
      const stat = document.createElement('div');
      stat.className = 'meta';
      stat.innerHTML = `<span class="pill">${membersCount} members</span> <small style="color:var(--muted)">Created ${formatWhen(group.createdAt)}</small>`;

      // Actions
      const actions = document.createElement('div');
      actions.className = 'card-actions';

      const enterBtn = document.createElement('button');
      enterBtn.className = 'btn btn-primary';
      enterBtn.textContent = 'Enter Group';
      enterBtn.onclick = () => openGroup(group.id);

      const leaveBtn = document.createElement('button');
      leaveBtn.className = 'btn btn-ghost';
      leaveBtn.textContent = 'Leave Group';
      leaveBtn.onclick = () => leaveGroup(group);

      // If user is admin — disable leave (or show transfer/confirm)
      const isAdmin = Array.isArray(group.members) && group.members.some(m => (m.uid === window.currentUser.uid || m.uid === window.currentUser.uid) && (m.role === 'admin' || m.role === 'owner'));
      if (isAdmin) {
        leaveBtn.disabled = true;
        leaveBtn.title = 'Group admins cannot leave — transfer admin or delete group';
        leaveBtn.style.opacity = '0.6';
      }

      actions.appendChild(enterBtn);
      actions.appendChild(leaveBtn);

      // append all
      card.appendChild(title);
      card.appendChild(subtitle);
      card.appendChild(stat);
      card.appendChild(actions);

      return card;
    }

    // Navigate to group-specific UI (replace with your actual group page)
    function openGroup(groupId) {
      window.location.href = `dashboard.html?group=${encodeURIComponent(groupId)}`;
    }

    // Remove the current user from group's members array (reads doc, updates)
    async function leaveGroup(group) {
      const uid = window.currentUser.uid;
      if (!confirm('Leave this group? You will lose access to group features.')) return;
      try {
        const groupRef = doc(db, 'groups', group.id);
        const groupSnap = await getDoc(groupRef);
        if (!groupSnap.exists()) {
          alert('Group not found');
          return;
        }
        const data = groupSnap.data();
        const members = Array.isArray(data.members) ? data.members.slice() : [];

        // filter out any object with uid === current uid (or string match)
        const newMembers = members.filter(m => {
          if (!m) return false;
          if (typeof m === 'string') return m !== uid;
          return (m.uid !== uid && m.userId !== uid);
        });

        await updateDoc(groupRef, {
          members: newMembers,
          updatedAt: serverTimestamp()
        });

        // refresh UI
        alert('You left the group.');
        await loadUserGroups(uid);
      } catch (err) {
        console.error('Leave group failed', err);
        alert('Failed to leave group — check console.');
      }
    }

    // helpers
    function shortenId(id='') {
      if (!id) return '—';
      return id.length > 8 ? id.slice(0,6)+'…'+id.slice(-2) : id;
    }
    function formatWhen(ts){
      try {
        if (!ts) return 'recent';
        // Firestore timestamp or string
        if (ts.seconds) ts = new Date(ts.seconds * 1000);
        if (!(ts instanceof Date)) ts = new Date(ts);
        const d = ts;
        const now = new Date();
        const diff = Math.round((now - d) / 1000 / 60); // minutes
        if (diff < 60) return `${diff}m ago`;
        const hours = Math.round(diff/60);
        if (hours < 24) return `${hours}h ago`;
        return d.toLocaleDateString();
      } catch(e){ return '—'; }
    }

  </script>
<div id="footer"></div>
<script type="module" src="js/load-partials.js"></script>
</body>
</html>
