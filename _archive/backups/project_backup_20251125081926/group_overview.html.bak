<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Group Overview ‚Äî Stokvel PRO</title>

  <!-- design system / base styles (assumes layout.css or similar is present) -->
  <link rel="stylesheet" href="/css/layout.css" />

  <!-- load header/footer partial loader (keeps partials consistent) -->
  <script type="module" src="/js/load-partials.js"></script>

  <style>
    /* Minimal page-specific polish to ensure layout looks correct even if main CSS missing */
    :root{
      --bg:#f5f7f9;
      --card:#ffffff;
      --muted:#7b8894;
      --accent:#2b78c9;
      --radius:14px;
      --gap:18px;
      --page-max:1200px;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); margin:0; color:#0b1720;}
    .container{max-width:var(--page-max); margin:28px auto; padding:0 20px;}
    header#header, footer#footer{width:100%;}
    h1{font-size:28px; margin:14px 0 10px;}
    .hero{background:linear-gradient(180deg,#f8fafc,white); padding:22px; border-radius:var(--radius); box-shadow:0 6px 20px rgba(11,23,32,0.04); display:flex; gap:16px; align-items:center;}
    .hero .left{flex:1}
    .hero .actions{display:flex; gap:10px}
    .btn{display:inline-block; padding:10px 16px; border-radius:10px; border:0; cursor:pointer; font-weight:600}
    .btn-primary{background:linear-gradient(90deg,#2176d9,#2ea1ff); color:white}
    .btn-ghost{background:transparent; border:1px solid #e6e9ed; color:var(--muted)}
    .kpis{display:flex; gap:var(--gap); margin-top:18px; flex-wrap:wrap}
    .kpi{background:var(--card); border-radius:12px; padding:18px; min-width:170px; flex:1; box-shadow:0 8px 24px rgba(11,23,32,0.04)}
    .kpi .label{color:var(--muted); font-size:13px}
    .kpi .value{font-size:20px; font-weight:800; margin-top:6px}
    .grid{display:grid; gap:var(--gap); grid-template-columns:1fr; margin-top:18px}
    @media(min-width:980px){ .grid{grid-template-columns: 1fr 360px;} }
    .card{background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:0 10px 30px rgba(11,23,32,0.04)}
    .card.list{min-height:140px}
    .card-header{margin:0 0 10px; font-size:18px; font-weight:800}
    .skeleton{background:linear-gradient(90deg,#eef2f6,#f6f8fb); border-radius:8px}
    .footer-nav{position:fixed; left:20px; right:20px; bottom:18px; background:var(--card); border-radius:36px; padding:12px 20px; box-shadow:0 12px 30px rgba(11,23,32,0.06); display:flex; justify-content:space-around; gap:8px; align-items:center}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:6px 10px; background:#f1f6fb; border-radius:999px; font-weight:700}
    /* small helpers */
    .stack{display:flex; gap:12px; align-items:center}
  </style>
</head>
<body>
  <!-- global header partial will be injected into this element -->
  <div id="header"></div>

  <main class="container" id="root">
    <h1>Group Overview</h1>

    <!-- HERO (summary) -->
    <section class="hero" aria-labelledby="group-name">
      <div class="left">
        <div id="group-badge" class="stack" style="gap:12px; align-items:flex-start;">
          <div style="width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,#2b78c9,#4ea8ff); display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:28px">G</div>
          <div>
            <div id="group-name" style="font-size:20px;font-weight:800">‚Äî ‚Ä¢ Code: ‚Äî</div>
            <div class="muted" id="group-sub">Using Stokvel PRO (R39/month)</div>
          </div>
        </div>
        <div style="margin-top:12px;">
          <img id="group-image" alt="Group image" src="" style="max-width:160px;border-radius:10px;display:none;" />
        </div>
      </div>

      <div style="min-width:240px; display:flex; gap:12px; flex-direction:column; align-items:flex-end;">
        <div style="display:flex; gap:12px;">
          <div class="kpi" style="min-width:140px;">
            <div class="label">Members</div>
            <div class="value" id="membersCount">‚Äî</div>
          </div>
          <div class="kpi" style="min-width:120px;">
            <div class="label">Monthly</div>
            <div class="value" id="groupMonthly">R 0</div>
          </div>
          <div class="kpi" style="min-width:120px;">
            <div class="label">Balance</div>
            <div class="value" id="groupBalance">R 0</div>
          </div>
        </div>

        <div class="actions">
          <button id="btn-contribute" class="btn btn-primary">+ Contribute</button>
          <button id="btn-settings" class="btn btn-ghost">Settings</button>
        </div>
      </div>
    </section>

    <!-- KPI + two column grid below -->
    <h2 style="margin-top:18px; font-size:20px;">Quick Summary</h2>

    <div class="grid">
      <!-- left column -->
      <div>
        <div class="card list" id="summaryCard">
          <div id="groupSummary" class="muted">Loading summary...</div>
          <hr style="margin:14px 0;">
          <h3 class="card-header">Recent Activity</h3>
          <div id="activityList">
            <div class="skeleton" style="height:46px; margin-bottom:8px;"></div>
            <div class="skeleton" style="height:46px;"></div>
          </div>
        </div>

        <div style="height:var(--gap)"></div>

        <div class="card" aria-labelledby="members-title">
          <h3 id="members-title" class="card-header">Members</h3>
          <div id="membersList" class="muted">Loading members‚Ä¶</div>
        </div>
      </div>

      <!-- right column -->
      <aside>
        <div class="card" style="margin-bottom:var(--gap);">
          <h3 class="card-header">Activity Feed</h3>
          <div id="activityFeed" class="muted">Loading‚Ä¶</div>
        </div>

        <div class="card" style="margin-bottom:var(--gap);">
          <h3 class="card-header">Calendar</h3>
          <div id="calendar" class="muted">No events</div>
        </div>

        <div class="card">
          <h3 class="card-header">Payout Cycle</h3>
          <div id="payoutInfo" class="muted">Loading payout cycle‚Ä¶</div>
          <hr style="margin:14px 0;">
          <h3 class="card-header">Presence</h3>
          <div id="presence" class="muted">Loading presence‚Ä¶</div>
        </div>
      </aside>
    </div>

    <!-- optional install PWA CTA -->
    <div style="margin-top:20px;">
      <button id="installAppBtn" class="btn btn-primary" style="display:none">Install Stokvel PRO</button>
    </div>
  </main>

  <!-- global footer will be injected here -->
  <div id="footer"></div>

  <!-- Minimal bottom nav (keeps original app behaviour) -->
  <nav class="footer-nav" aria-hidden="false">
    <a class="muted" href="index.html">üè† Home</a>
    <a class="muted" href="groups.html">üìÅ Groups</a>
    <a class="muted" href="notifications.html">üîî Alerts</a>
    <a class="muted" href="profile.html">üë§ Profile</a>
  </nav>

  <!-- ======================
       Clean, defensive module JS
       ====================== -->
  <script type="module">
    /**
     * group_overview.html ‚Äî cleaned & production-ready JS
     * - Defensive: works even if Firebase helpers not loaded yet
     * - Tries a few common project helper entrypoints:
     *   1) window.getGroupById(gid)  (preferred if existing)
     *   2) window.fetchGroupData(gid)
     *   3) fallback: uses no remote fetch (keeps placeholders)
     *
     * Wire this to your Firestore helper by exposing a function:
     *   window.getGroupById = async (gid) => { ... return groupDocData ... }
     *
     * The returned object the script expects (example):
     * {
     *   id: "gid",
     *   name: "My Group",
     *   code: "ABC123",
     *   monthly: 250,
     *   balance: 3200.50,
     *   membersCount: 8,
     *   imageURL: "/assets/..png",
     *   summary: "Short summary text",
     *   activity: [ {id, title, timestamp, amount, type}, ... ],
     *   payoutCycle: "Monthly",
     *   rotationIndex: 2
     * }
     */

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const els = {
      name: $('#group-name'),
      sub: $('#group-sub'),
      image: $('#group-image'),
      membersCount: $('#membersCount'),
      groupMonthly: $('#groupMonthly'),
      groupBalance: $('#groupBalance'),
      groupSummary: $('#groupSummary'),
      activityList: $('#activityList'),
      membersList: $('#membersList'),
      activityFeed: $('#activityFeed'),
      payoutInfo: $('#payoutInfo'),
      presence: $('#presence'),
      installBtn: $('#installAppBtn'),
      btnContribute: $('#btn-contribute'),
      btnSettings: $('#btn-settings')
    };

    // small helpers
    const fmtCurrency = v => (typeof v === 'number') ? `R ${v.toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:2})}` : 'R 0';
    const fmtCount = v => (v === undefined || v === null) ? '‚Äî' : String(v);

    async function tryFetchGroup(gid) {
      // 1) preferred: window.getGroupById
      if (window.getGroupById && typeof window.getGroupById === 'function') {
        try {
          return await window.getGroupById(gid);
        } catch (e) {
          console.warn('getGroupById failed', e);
        }
      }

      // 2) alternative helper
      if (window.fetchGroupData && typeof window.fetchGroupData === 'function') {
        try {
          return await window.fetchGroupData(gid);
        } catch (e) {
          console.warn('fetchGroupData failed', e);
        }
      }

      // 3) as last resort: try to import a project module (if present)
      try {
        // many projects export Firestore wrappers ‚Äî we try to import one if it exists
        const mod = await import('/js/group_overview.api.js').catch(()=>null);
        if (mod && mod.getGroupById) {
          return await mod.getGroupById(gid);
        }
      } catch(err) {
        // ignore
      }

      // no remote source found
      return null;
    }

    function renderGroup(data) {
      if (!data) {
        els.name.textContent = 'Group not found';
        els.groupSummary.textContent = 'Could not load group data ‚Äî make sure your Firebase helpers are available.';
        return;
      }

      els.name.textContent = data.name || `Group ‚Ä¢ Code: ${data.code || '‚Äî'}`;
      els.sub.textContent = data.tagline || (data.paid ? 'Using Stokvel PRO (R39/month)' : 'Using Stokvel PRO (trial)');
      if (data.imageURL) {
        els.image.src = data.imageURL;
        els.image.style.display = 'block';
      } else {
        els.image.style.display = 'none';
      }

      els.membersCount.textContent = fmtCount(data.membersCount);
      els.groupMonthly.textContent = fmtCurrency(data.monthly || data.contributionAmount || 0);
      els.groupBalance.textContent = fmtCurrency(data.balance || data.groupBalance || 0);
      els.groupSummary.textContent = data.summary || 'No summary available.';

      // activity
      const act = Array.isArray(data.activity) ? data.activity : [];
      if (act.length === 0) {
        els.activityList.innerHTML = '<div class="muted">No recent activity</div>';
      } else {
        els.activityList.innerHTML = '';
        act.slice(0,6).forEach(item=>{
          const row = document.createElement('div');
          row.style.padding = '8px 0';
          row.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700">${item.title || item.type || 'Activity'}</div>
                <div class="muted" style="font-size:13px">${item.note || ''}</div>
              </div>
              <div style="text-align:right">
                <div style="font-weight:700">${item.amount ? fmtCurrency(item.amount) : ''}</div>
                <div class="muted" style="font-size:12px">${item.when ? new Date(item.when).toLocaleString() : ''}</div>
              </div>
            </div>
          `;
          els.activityList.appendChild(row);
        });
      }

      // members list
      if (Array.isArray(data.members) && data.members.length) {
        els.membersList.innerHTML = data.members.slice(0,10).map(m => `<div style="padding:6px 0">${m.name || m.phone || m.uid}</div>`).join('');
      } else {
        els.membersList.innerHTML = '<div class="muted">No members yet.</div>';
      }

      // payout and presence
      els.payoutInfo.textContent = data.payoutCycle ? `${data.payoutCycle} ‚Ä¢ next: ${data.nextPayoutDate || '‚Äî'}` : 'No payout cycle set.';
      els.presence.textContent = data.presence || 'Not available';
    }

    function attachUIHandlers(gid) {
      if (els.btnContribute) {
        els.btnContribute.addEventListener('click', ()=> {
          // prefer an existing route or open a modal
          const contributeUrl = `create_contribution.html?gid=${encodeURIComponent(gid || '')}`;
          location.href = contributeUrl;
        });
      }
      if (els.btnSettings) {
        els.btnSettings.addEventListener('click', ()=> {
          location.href = `group_admin.html?gid=${encodeURIComponent(gid || '')}`;
        });
      }

      // PWA install button: listen for a deferred prompt if app supports it
      window.deferredInstallPrompt && (els.installBtn.style.display = 'inline-block');
      if (els.installBtn) {
        els.installBtn.addEventListener('click', async () => {
          if (window.deferredInstallPrompt) {
            window.deferredInstallPrompt.prompt();
            const choice = await window.deferredInstallPrompt.userChoice;
            console.log('PWA install result:', choice);
          } else {
            console.log('No install prompt available');
          }
        });
      }
    }

    // init flow
    (async function init(){
      // read gid from query param ?gid=
      const params = new URLSearchParams(location.search);
      const gid = params.get('gid') || params.get('id') || null;

      attachUIHandlers(gid);

      if (!gid) {
        // no gid -> show placeholders
        document.title = 'Group Overview ‚Äî Stokvel PRO';
        return renderGroup(null);
      }

      // indicate loading UI
      els.groupSummary.textContent = 'Loading‚Ä¶';
      els.activityList.innerHTML = '<div class="skeleton" style="height:46px; margin-bottom:8px;"></div>';

      // attempt to fetch group with multiple fallback options
      const group = await tryFetchGroup(gid);

      renderGroup(group);

      // if the project exposes a real-time subscription helper, wire it up:
      // example: window.subscribeToGroup(gid, (newData)=> renderGroup(newData))
      if (window.subscribeToGroup && typeof window.subscribeToGroup === 'function') {
        try {
          window.subscribeToGroup(gid, newData => {
            if (newData) renderGroup(newData);
          });
        } catch(e) {
          console.warn('subscribeToGroup failed:', e);
        }
      }

    })();

  </script>
</body>
</html>
