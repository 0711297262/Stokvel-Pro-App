<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Group Admin — StokvelPRO</title>

  <style>
    :root{
      --primary:#1a365d;
      --accent:#2b6cb0;
      --muted:#94a3b8;
      --glass-bg: rgba(255,255,255,0.06);
      --card-bg: rgba(255,255,255,0.9);
      --radius:16px;
    }

    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#eaf4ff}
    body{
      /* Compact header style: subtle background image with dark overlay */
      background: linear-gradient(180deg, rgba(10,20,36,0.88), rgba(8,14,26,0.95)), url("/mnt/data/final image copy.png");
      background-size: cover;
      background-position: center;
      -webkit-font-smoothing:antialiased;
    }

    /* compact header */
    header.compact {
      height:64px;
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 18px;
      backdrop-filter: blur(6px);
      background: linear-gradient(90deg, rgba(10,20,36,0.55), rgba(15,25,45,0.35));
      border-bottom: 1px solid rgba(255,255,255,0.04);
      color: white;
    }
    .compact .title { font-weight:800; font-size:18px }
    .compact .subtitle { font-size:13px; color:var(--muted) }

    /* layout */
    .wrap{max-width:1100px;margin:18px auto;padding:18px;display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
    .glass-panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius:var(--radius);
      padding:16px;
      box-shadow: 0 12px 40px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.04);
      color: #eaf4ff;
    }

    .card-white{
      background: white;
      color: #0b1724;
      border-radius:12px;
      padding:14px;
      box-shadow: 0 8px 24px rgba(2,6,23,0.18);
    }

    .section { margin-bottom:14px }
    .section h3 { margin:0 0 8px 0; font-size:16px }
    .muted { color:var(--muted) }

    .row { display:flex;gap:8px;align-items:center }
    .btn { padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700 }
    .btn-primary { background:linear-gradient(90deg,var(--accent),var(--primary)); color:white }
    .btn-ghost { background:transparent;border:1px solid rgba(255,255,255,0.06); color: #eaf4ff }
    .btn-danger { background:#ef4444; color:white }

    input, select, textarea {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color: #eaf4ff;
      outline:none;
    }

    label { display:block; font-size:13px; margin-bottom:6px; color: #eaf4ff }

    .members-list { display:flex; flex-direction:column; gap:8px }
    .member { display:flex; align-items:center; justify-content:space-between; padding:8px; border-radius:10px; background: rgba(255,255,255,0.02) }
    .member .meta { display:flex; gap:10px; align-items:center }
    .avatar { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; background: linear-gradient(135deg,var(--accent),var(--primary)); color:white }

    @media (max-width:980px){
      .wrap{grid-template-columns:1fr;padding:12px}
    }
  </style>
</head>
<body>
<div id="header"></div>
  <!-- Compact header -->
  <header class="compact" role="banner">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="width:44px;height:44px;border-radius:10px;overflow:hidden;background:linear-gradient(135deg,var(--accent),var(--primary));display:flex;align-items:center;justify-content:center;font-weight:900">SP</div>
      <div>
        <div class="title">Admin Panel</div>
        <div class="subtitle">Manage group settings, members & roles</div>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button class="btn btn-ghost" onclick="goBack()">Back</button>
    </div>
  </header>

  <div class="wrap" role="main">
    <!-- LEFT: admin workspace -->
    <main>
      <div class="glass-panel">
        <div class="section" style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <h2 id="groupTitle" style="margin:0">Loading group…</h2>
            <div id="groupCode" class="muted" style="margin-top:6px">Code: —</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Balance</div>
            <div style="font-weight:800;font-size:18px">R <span id="bal">0</span></div>
          </div>
        </div>

        <!-- Group basics editing -->
        <div class="section" style="margin-top:12px">
          <h3>Group Settings</h3>
          <label>Group name</label>
          <input id="editGroupName" placeholder="Group name" />

          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-primary" onclick="saveGroupName()">Save name</button>
            <button class="btn btn-ghost" onclick="toggleArchive()">Archive group</button>
          </div>
        </div>

        <!-- Contribution settings -->
        <div class="section">
          <h3>Contribution Settings</h3>
          <label>Monthly contribution (R)</label>
          <input id="contribAmt" type="number" placeholder="0" />

          <label style="margin-top:8px">Payout cycle</label>
          <select id="payoutCycle">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="quarterly">Quarterly</option>
          </select>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-primary" onclick="saveContribution()">Save</button>
            <button class="btn btn-ghost" onclick="resetContribution()">Reset</button>
          </div>
        </div>

        <!-- Member management -->
        <div class="section">
          <h3>Members</h3>
          <div class="members-list" id="membersList">Loading members…</div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <input id="invitePhoneAdmin" placeholder="+27 82 000 0000" />
            <button class="btn btn-primary" onclick="adminSendInvite()">Invite</button>
          </div>
        </div>

        <!-- Audit / actions -->
        <div class="section">
          <h3>Audit & Actions</h3>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost" onclick="viewAudit()">View audit log</button>
            <button class="btn btn-danger" onclick="forceArchive()">Archive & Lock</button>
          </div>
        </div>
      </div>
    </main>

    <!-- RIGHT: admin sidebar -->
    <aside>
      <div class="glass-panel card-white">
        <h3 style="margin-top:0">Quick Info</h3>
        <div class="muted" id="createdBy">Created by: —</div>
        <div class="muted" id="createdAt">Created: —</div>
        <div style="height:12px"></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" onclick="openGroupOverview()">Open Overview</button>
          <button class="btn btn-ghost" onclick="openChat()">Open Chat</button>
        </div>
      </div>

      <div class="glass-panel" style="margin-top:12px">
        <h3 style="margin-top:0">Role Tools</h3>
        <div style="margin-bottom:8px" class="muted">Select a member then choose an action</div>
        <select id="memberSelector" style="margin-bottom:8px">
          <option value="">Select member…</option>
        </select>

        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" onclick="promote()">Promote to Admin</button>
          <button class="btn btn-ghost" onclick="demote()">Demote to Member</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-danger" onclick="removeMember()">Remove</button>
        </div>
      </div>
    </aside>
  </div>

  <script type="module" src="js/auth-guard.js"></script>

    // Firebase imports (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAUIOcaIXcVRPBCG_95-TttwYD32yoJSG8",
      authDomain: "stokvelpro.firebaseapp.com",
      projectId: "stokvelpro",
      storageBucket: "stokvelpro.firebasestorage.app",
      messagingSenderId: "655524343942",
      appId: "1:655524343942:web:03d5ca1374a794e3ee6107",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Helpers & UI refs
    const url = new URL(window.location.href);
    const gid = url.searchParams.get('gid'); // admin must open with gid
    const groupTitle = document.getElementById('groupTitle');
    const groupCode = document.getElementById('groupCode');
    const balEl = document.getElementById('bal');
    const createdByEl = document.getElementById('createdBy');
    const createdAtEl = document.getElementById('createdAt');
    const membersListEl = document.getElementById('membersList');
    const memberSelector = document.getElementById('memberSelector');

    let currentUser = null;
    let currentGroup = null;
    let membersUnsub = null;

    function goBack(){ window.location.href='group_overview.html?gid=' + (gid || '') }

    onAuthStateChanged(auth, async (user) => {
      if(!user) return window.location.href = 'index.html';
      currentUser = user;
      if(!gid) return alert('Open this admin panel from the group overview (gid required)');
      await loadGroup(gid);
    });

    async function loadGroup(gidParam){
      try{
        const gRef = doc(db, 'groups', gidParam);
        const gSnap = await getDoc(gRef);
        if(!gSnap.exists()){
          alert('Group not found'); return;
        }
        const g = gSnap.data();
        currentGroup = { id: gidParam, ...g };

        groupTitle.textContent = g.groupName || 'Group';
        groupCode.textContent = 'Code: ' + (g.groupCode || '—');
        balEl.textContent = g.groupBalance || 0;
        createdByEl.textContent = 'Created by: ' + (g.createdBy || '—');
        createdAtEl.textContent = 'Created: ' + (g.createdAt ? new Date(g.createdAt.seconds*1000).toLocaleDateString() : '—');

        document.getElementById('editGroupName').value = g.groupName || '';
        document.getElementById('contribAmt').value = g.contributionAmount || '';

        // check if current user is admin
        const myMemberRef = doc(db, 'groups', gidParam, 'members', currentUser.uid);
        const myMemberSnap = await getDoc(myMemberRef);
        if(!myMemberSnap.exists() || !['admin','chair'].includes(myMemberSnap.data().role)){
          alert('You must be an admin to use this panel'); window.location.href = 'group_overview.html?gid=' + gidParam; return;
        }

        // realtime members
        const membersRef = collection(db, 'groups', gidParam, 'members');
        membersUnsub = onSnapshot(membersRef, (snap) => {
          membersListEl.innerHTML = '';
          memberSelector.innerHTML = '<option value="">Select member…</option>';
          snap.forEach(docSnap => {
            const m = docSnap.data();
            const id = docSnap.id;
            const div = document.createElement('div');
            div.className = 'member';
            div.innerHTML = `
              <div class="meta">
                <div class="avatar">${(m.name||m.phone||'M')[0]}</div>
                <div>
                  <div style="font-weight:800">${m.name || m.phone || 'Member'}</div>
                  <div class="muted">${m.role || 'member'}</div>
                </div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost" onclick="editMember('${id}')">Edit</button>
                <button class="btn btn-danger" onclick="removeMemberById('${id}')">Remove</button>
              </div>
            `;
            membersListEl.appendChild(div);

            // add to selector
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = m.name || m.phone || id;
            memberSelector.appendChild(opt);
          });
        });

      }catch(err){
        console.error('loadGroup', err);
        alert('Failed to load group');
      }
    }

    // Save group name
    async function saveGroupName(){
      const val = document.getElementById('editGroupName').value.trim();
      if(!val) return alert('Enter group name');
      try{
        await updateDoc(doc(db, 'groups', gid), { groupName: val });
        alert('Saved');
      }catch(err){ console.error(err); alert('Failed to save'); }
    }

    function toggleArchive(){ alert('Archive toggle (soft-delete) — implemented in backend later)'); }

    async function saveContribution(){
      const val = Number(document.getElementById('contribAmt').value || 0);
      const cycle = document.getElementById('payoutCycle').value;
      if(!val) return alert('Enter amount');
      try{
        await updateDoc(doc(db, 'groups', gid), { contributionAmount: val, payoutCycle: cycle });
        alert('Contribution settings saved');
      }catch(err){ console.error(err); alert('Failed to save'); }
    }

    function resetContribution(){ document.getElementById('contribAmt').value = ''; }

    // Invite from admin
    async function adminSendInvite(){
      const phone = document.getElementById('invitePhoneAdmin').value.trim();
      if(!phone) return alert('Enter phone');
      try{
        await addDoc(collection(db, 'invites'), { groupId: gid, phone, createdBy: currentUser.uid, createdAt: serverTimestamp(), used:false });
        alert('Invite recorded');
        document.getElementById('invitePhoneAdmin').value = '';
      }catch(err){ console.error(err); alert('Failed to create invite'); }
    }

    // Promote/demote/remove by selector
    async function promote(){
      const uid = memberSelector.value; if(!uid) return alert('Pick a member');
      try{ await updateDoc(doc(db, 'groups', gid, 'members', uid), { role: 'admin' }); alert('Promoted'); } catch(e){console.error(e);alert('Failed');}
    }
    async function demote(){
      const uid = memberSelector.value; if(!uid) return alert('Pick a member');
      try{ await updateDoc(doc(db, 'groups', gid, 'members', uid), { role: 'member' }); alert('Demoted'); } catch(e){console.error(e);alert('Failed');}
    }
    async function removeMember(){
      const uid = memberSelector.value; if(!uid) return alert('Pick a member');
      if(!confirm('Remove member?')) return;
      try{ await updateDoc(doc(db, 'groups', gid, 'members', uid), { removed: true, removedAt: serverTimestamp() }); alert('Removed'); } catch(e){console.error(e);alert('Failed');}
    }

    async function removeMemberById(id){
      if(!confirm('Remove member?')) return;
      try{ await updateDoc(doc(db, 'groups', gid, 'members', id), { removed: true, removedAt: serverTimestamp() }); alert('Removed'); } catch(e){console.error(e);alert('Failed');}
    }

    function editMember(id){
      window.location.href = 'profile.html?uid=' + id + '&gid=' + gid;
    }

    function viewAudit(){ alert('Audit viewer — coming soon (logs)'); }
    function forceArchive(){ if(confirm('Archive & lock group?')) { updateDoc(doc(db,'groups',gid), { status:'archived', archivedAt: serverTimestamp() }); alert('Archived'); window.location.href='dashboard.html'; } }

    function openGroupOverview(){ window.location.href = 'group_overview.html?gid=' + gid; }
    function openChat(){ window.location.href = 'chat.html?gid=' + gid; }

  </script>
<div id="footer"></div>
<script type="module" src="js/load-partials.js"></script>
</body>
</html>
